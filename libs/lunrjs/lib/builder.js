/*!
 * lunr.Builder
 * Copyright (C) @YEAR Oliver Nightingale
 */
lunr.Builder=function(){this._ref="id",this._fields=Object.create(null),this._documents=Object.create(null),this.invertedIndex=Object.create(null),this.fieldTermFrequencies={},this.fieldLengths={},this.tokenizer=lunr.tokenizer,this.pipeline=new lunr.Pipeline,this.searchPipeline=new lunr.Pipeline,this.documentCount=0,this._b=.75,this._k1=1.2,this.termIndex=0,this.metadataWhitelist=[]},lunr.Builder.prototype.ref=function(e){this._ref=e},lunr.Builder.prototype.field=function(e,t){if(/\//.test(e))throw new RangeError("Field '"+e+"' contains illegal character '/'");this._fields[e]=t||{}},lunr.Builder.prototype.b=function(e){this._b=e<0?0:e>1?1:e},lunr.Builder.prototype.k1=function(e){this._k1=e},lunr.Builder.prototype.add=function(e,t){var i=e[this._ref],n=Object.keys(this._fields);this._documents[i]=t||{},this.documentCount+=1;for(var r=0;r<n.length;r++){var s=n[r],l=this._fields[s].extractor,d=l?l(e):e[s],h=this.tokenizer(d,{fields:[s]}),o=this.pipeline.run(h),u=new lunr.FieldRef(i,s),a=Object.create(null);this.fieldTermFrequencies[u]=a,this.fieldLengths[u]=0,this.fieldLengths[u]+=o.length;for(var c=0;c<o.length;c++){var f=o[c];if(a[f]==undefined&&(a[f]=0),a[f]+=1,this.invertedIndex[f]==undefined){var p=Object.create(null);p._index=this.termIndex,this.termIndex+=1;for(var v=0;v<n.length;v++)p[n[v]]=Object.create(null);this.invertedIndex[f]=p}this.invertedIndex[f][s][i]==undefined&&(this.invertedIndex[f][s][i]=Object.create(null));for(var g=0;g<this.metadataWhitelist.length;g++){var b=this.metadataWhitelist[g],_=f.metadata[b];this.invertedIndex[f][s][i][b]==undefined&&(this.invertedIndex[f][s][i][b]=[]),this.invertedIndex[f][s][i][b].push(_)}}}},lunr.Builder.prototype.calculateAverageFieldLengths=function(){for(var e=Object.keys(this.fieldLengths),t=e.length,i={},n={},r=0;r<t;r++){var s=lunr.FieldRef.fromString(e[r]),l=s.fieldName;n[l]||(n[l]=0),n[l]+=1,i[l]||(i[l]=0),i[l]+=this.fieldLengths[s]}var d=Object.keys(this._fields);for(r=0;r<d.length;r++){var h=d[r];i[h]=i[h]/n[h]}this.averageFieldLength=i},lunr.Builder.prototype.createFieldVectors=function(){for(var e={},t=Object.keys(this.fieldTermFrequencies),i=t.length,n=Object.create(null),r=0;r<i;r++){for(var s=lunr.FieldRef.fromString(t[r]),l=s.fieldName,d=this.fieldLengths[s],h=new lunr.Vector,o=this.fieldTermFrequencies[s],u=Object.keys(o),a=u.length,c=this._fields[l].boost||1,f=this._documents[s.docRef].boost||1,p=0;p<a;p++){var v,g,b,_=u[p],m=o[_],k=this.invertedIndex[_]._index;n[_]===undefined?(v=lunr.idf(this.invertedIndex[_],this.documentCount),n[_]=v):v=n[_],g=v*((this._k1+1)*m)/(this._k1*(1-this._b+this._b*(d/this.averageFieldLength[l]))+m),g*=c,g*=f,b=Math.round(1e3*g)/1e3,h.insert(k,b)}e[s]=h}this.fieldVectors=e},lunr.Builder.prototype.createTokenSet=function(){this.tokenSet=lunr.TokenSet.fromArray(Object.keys(this.invertedIndex).sort())},lunr.Builder.prototype.build=function(){return this.calculateAverageFieldLengths(),this.createFieldVectors(),this.createTokenSet(),new lunr.Index({invertedIndex:this.invertedIndex,fieldVectors:this.fieldVectors,tokenSet:this.tokenSet,fields:Object.keys(this._fields),pipeline:this.searchPipeline})},lunr.Builder.prototype.use=function(e){var t=Array.prototype.slice.call(arguments,1);t.unshift(this),e.apply(this,t)};